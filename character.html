<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>co:meç€ã›æ›¿ãˆ</title>
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">


    <style>
        * {
            font-family: "Kosugi Maru", sans-serif !important;
        }

        /* ã‚¢ãƒ—ãƒªå†…ã®ã™ã¹ã¦ã®è¦ç´ ã« Kiwi Maru ã‚’é©ç”¨ */
        /* ãƒœã‚¿ãƒ³ã€å…¥åŠ›æ¬„ã€ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚‚é©ç”¨ */
        button,
        input,
        select,
        textarea {
            font-family: "Kosugi Maru", sans-serif;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            font-family: sans-serif;
            width: 100%;
        }

        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .menu {
            margin-top: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            border-radius: 30px;
            background: white;
            font-weight: bold;
            font-size: 14px;
        }

        button.active {
            background: #ff6b6b;
            color: white;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            background: #55bbbf;
            z-index: 1000;
            height: 100px;
            justify-content: center;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .nav-bar img {
            width: 100px;
            height: auto;
            pointer-events: none;
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆèƒŒæ™¯ï¼‰ --- */
        #stage {
            width: 100%;
            height: calc(100vh - 180px);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            position: relative;
            background-repeat: no-repeat;
            background-position: center bottom;
            background-color: #f7e1c3;
            background-size: auto 100%;
            touch-action: none;
            user-select: none;
            overflow: hidden;
        }

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ --- */
        #character {
            position: relative;
            width: 400px;
            height: 340px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            transform-origin: center bottom;
            transition: transform 0.3s ease;
        }

        .part {
            position: absolute;
            width: 350px;
            height: 350px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
        }

        #body {
            z-index: 1;
            bottom: 0;
        }

        #face {
            z-index: 2;
            top: 0;
        }

        /* ç€ã›æ›¿ãˆã‚¢ã‚¤ãƒ†ãƒ ç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #equipped-item {
            z-index: 10;
            position: absolute;
            /* çµ¶å¯¾é…ç½® */
            top: 0;
            left: 0;
            width: 350px;
            height: 350px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            /* transitionã‚’å…¥ã‚Œã‚‹ã¨ç€æ›¿ãˆãŸæ™‚ã«ãµã‚ã£ã¨å‹•ãã¾ã™ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
            transition: transform 0.2s ease-out;
        }

        /* --- ç›® --- */
        .eye-container {
            position: absolute;
            top: 70%;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 50px;
            z-index: 3;
        }

        .eye-wrap {
            width: 80px;
            height: 30px;
            position: relative;
            background-color: #fff;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #704c19;
        }

        .eye-ball {
            width: 70px;
            height: 25px;
            background-color: #704c19;
            border-radius: 50%;
            position: absolute;
        }

        @media (max-width: 480px) {
            #character {
                transform: scale(1.3);
            }

            #stage {
                background-size: auto 120%;
                background-position: center 80%;
            }
        }
    </style>
</head>

<body>
    <main>
        <div id="stage">
            <div class="menu">
                <button onclick="changeChar('cat')" id="btn-cat" class="active">ãƒã‚³ã®ãŠéƒ¨å±‹</button>
                <button onclick="changeChar('bird')" id="btn-bird">ãƒˆãƒªã®å¤§ç©º</button>
                <button onclick="changeChar('sheep')" id="btn-sheep">ãƒ’ãƒ„ã‚¸ã®è‰åŸ</button>
            </div>

            <div id="character">
                <div class="part" id="body"></div>
                <div class="part" id="face">
                    <div id="equipped-item" class="part"></div>

                    <div class="eye-container">
                        <div class="eye-wrap">
                            <div class="eye-ball" id="eyeL"></div>
                        </div>
                        <div class="eye-wrap">
                            <div class="eye-ball" id="eyeR"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu" style="margin-bottom: 110px;">
                <button onclick="openCloset()" style="background: #ffeb3b; color: #333;">ğŸ‘— ãã›ã‹ãˆã‚’ã™ã‚‹</button>
            </div>
        </div>
    </main>

    <div id="closet-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;"
        onclick="closeCloset()">
        <div style="background:white; padding:20px; border-radius:20px; width:85%; max-width:400px;"
            onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">ãƒ­ã‚°ã¡ã‚ƒã‚“ã®ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ</h3>
            <p style="font-size: 14px;">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span id="user-points"
                    style="font-weight:bold; color: #fb8c00;">0</span> pt</p>
            <div id="item-shop"
                style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px;"></div>
            <button onclick="closeCloset()" style="width:100%; background:#eee;">ã¨ã˜ã‚‹</button>
        </div>
    </div>

    <footer>
        <nav class="nav-bar">
            <a href="index.html" class="nav-item"><img src="imgs/top-icon-home.png" alt=""></a>
            <a href="calendar.html" class="nav-item"><img src="imgs/top-icon-calendar.png" alt=""></a>
            <a href="puzzle.html" class="nav-item"><img src="imgs/top-icon-game.png" alt=""></a>
        </nav>
    </footer>

    <script>
        let mouseX = window.innerWidth / 2, mouseY = window.innerHeight / 2;
        let current = 'cat';
        const POINT_STORAGE_KEY = 'user_total_points'; // å¸¸ã«ã“ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨

        // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š ---
        const charData = {
            cat: {
                bg: 'imgs/character/room.png',
                body: 'imgs/character/cat_body.png',
                face: 'imgs/character/cat_face.png',
                config: { isCircle: false, speed: 0.05, eyeRangeX: 8, eyeRangeY: 4, rotate: 0.03, eyeTop: '42%', eyeGap: '45px', eyeRotate: '0deg', eyeSize: 1, bodyZ: 1 }
            },
            bird: {
                bg: 'imgs/character/room.png',
                body: 'imgs/character/bird_body.png',
                face: 'imgs/character/bird_face.png',
                config: { isCircle: true, speed: 0.1, eyeRangeX: 10, eyeRangeY: 10, rotate: 0.08, eyeTop: '36%', eyeGap: '40px', eyePaddingRight: '40px', ballSize: 1.9, eyeRotate: '4deg', eyeSize: 0.7, bodyZ: 1 }
            },
            sheep: {
                bg: 'imgs/character/room.png',
                body: 'imgs/character/sheep_body.png',
                face: 'imgs/character/sheep_face.png',
                config: { isCircle: false, speed: 0.02, eyeRangeX: 3, eyeRangeY: 3, rotate: 0.01, eyeTop: '40%', eyeGap: '45px', eyeRotate: '0deg', ballSize: 1, eyeSize: 0.78, bodyZ: 3 }
            }
        };

        // --- ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ è¨­å®š ---
        const CLOSET_ITEMS = [
            { id: 'hat_basic', name: 'ã¼ã†ã—', price: 50, img: 'imgs/character/hat.png', offsetY: '-60px', offsetX: '0px', scale: '0.8' },
            { id: 'ribbon_red', name: 'ãƒªãƒœãƒ³', price: 30, img: 'imgs/character/ribbon.png', offsetY: '-75px', offsetX: '70px', scale: '0.8' },
            { id: 'megane', name: 'ãƒ¡ã‚¬ãƒ', price: 10, img: 'imgs/character/glasses.png', offsetY: '-10px', offsetX: '0px', scale: '0.5' }
        ];

        // --- ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ä¿®å¾© ---
        let userPoints = parseInt(localStorage.getItem(POINT_STORAGE_KEY) || '0');

        // â˜… é‡è¦ï¼šãƒã‚¤ãƒŠã‚¹ã«ãªã£ã¦ã„ãŸã‚‰0ã«æˆ»ã™æ•‘æ¸ˆå‡¦ç½®
        if (userPoints < 0) {
            userPoints = 0;
            localStorage.setItem(POINT_STORAGE_KEY, '0');
        }

        let ownedItems = JSON.parse(localStorage.getItem('owned_items') || '[]');
        let equippedData = JSON.parse(localStorage.getItem('equipped_data') || '{"cat":"","bird":"","sheep":""}');

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¤‰æ›´
        function changeChar(id) {
            current = id;
            const data = charData[id];
            const conf = data.config;

            document.getElementById('stage').style.backgroundImage = `url(${data.bg})`;
            document.getElementById('body').style.backgroundImage = `url(${data.body})`;
            document.getElementById('face').style.backgroundImage = `url(${data.face})`;
            document.getElementById('body').style.zIndex = conf.bodyZ;

            const container = document.querySelector('.eye-container');
            container.style.top = conf.eyeTop;
            container.style.gap = conf.eyeGap;
            container.style.transform = `rotate(${conf.eyeRotate})`;
            container.style.paddingLeft = conf.eyePaddingLeft || '0px';

            const eyeWraps = document.querySelectorAll('.eye-wrap');
            const eyeBalls = [document.getElementById('eyeL'), document.getElementById('eyeR')];

            eyeWraps.forEach((wrap, index) => {
                const ball = eyeBalls[index];
                const s = conf.eyeSize;
                const bs = conf.ballSize || 1.0;
                wrap.style.display = (conf.isSingleEye && index === 1) ? 'none' : 'flex';
                if (conf.isCircle) {
                    wrap.style.width = wrap.style.height = (60 * s) + 'px';
                    ball.style.width = ball.style.height = (30 * s * bs) + 'px';
                } else {
                    wrap.style.width = (80 * s) + 'px'; wrap.style.height = (30 * s) + 'px';
                    ball.style.width = (70 * s * bs) + 'px'; ball.style.height = (30 * s * bs) + 'px';
                }
            });

            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + id);
            if (activeBtn) activeBtn.classList.add('active');

            updateEquipDisplay();
        }

        // ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆé–¢é€£
        function openCloset() {
            document.getElementById('closet-modal').style.display = 'flex';
            renderCloset();
        }

        function closeCloset() {
            document.getElementById('closet-modal').style.display = 'none';
        }

        function renderCloset() {
            const shop = document.getElementById('item-shop');
            document.getElementById('user-points').innerText = userPoints;
            shop.innerHTML = CLOSET_ITEMS.map(item => {
                const isOwned = ownedItems.includes(item.id);
                const isEquipped = equippedData[current] === item.img;
                return `
                    <div style="text-align:center; border:1px solid #ddd; padding:8px; border-radius:12px; background:${isEquipped ? '#fff3e0' : 'white'}; border-color:${isEquipped ? '#ff6b6b' : '#ddd'}">
                        <img src="${item.img}" style="width:100%; height:40px; object-fit:contain; margin-bottom:5px;">
                        <div style="font-size:10px; margin-bottom:5px;">${item.name}</div>
                        ${isOwned ?
                        `<button onclick="equipItem('${item.img}')" style="font-size:10px; padding:4px 8px; width:100%; border-radius:10px; background:${isEquipped ? '#ff6b6b' : '#eee'}; color:${isEquipped ? 'white' : '#333'}">${isEquipped ? 'è„±ã' : 'ç€ã‚‹'}</button>` :
                        `<button onclick="buyItem('${item.id}', ${item.price})" style="font-size:10px; padding:4px 8px; width:100%; border-radius:10px; background:#4caf50; color:white;">${item.price}pt</button>`
                    }
                    </div>
                `;
            }).join('');
        }

        function buyItem(id, price) {
            if (userPoints >= price) {
                userPoints -= price;
                ownedItems.push(id);
                localStorage.setItem(POINT_STORAGE_KEY, userPoints);
                localStorage.setItem('owned_items', JSON.stringify(ownedItems));
                renderCloset();
            } else {
                alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ã‚ˆï¼ãƒ‘ã‚ºãƒ«ã‚’ã—ã¦è²¯ã‚ã¦ãã¦ã­ã€‚");
            }
        }

        function equipItem(imgSrc) {
            equippedData[current] = (equippedData[current] === imgSrc) ? "" : imgSrc;
            localStorage.setItem('equipped_data', JSON.stringify(equippedData));
            updateEquipDisplay();
            renderCloset();
        }

        function updateEquipDisplay() {
            const itemLayer = document.getElementById('equipped-item');
            const currentImg = equippedData[current];
            if (currentImg) {
                const itemInfo = CLOSET_ITEMS.find(item => item.img === currentImg);
                itemLayer.style.backgroundImage = `url(${currentImg})`;
                itemLayer.style.display = 'block';
                if (itemInfo) {
                    itemLayer.style.transform = `translate(${itemInfo.offsetX || '0px'}, ${itemInfo.offsetY || '0px'}) scale(${itemInfo.scale || '1'})`;
                }
            } else {
                itemLayer.style.display = 'none';
            }
        }

        function loop() {
            const face = document.getElementById('face');
            const eyeL = document.getElementById('eyeL');
            const eyeR = document.getElementById('eyeR');
            const body = document.getElementById('body');
            if (!face) return;

            const rect = face.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const dx = mouseX - cx;
            const dy = mouseY - cy;
            const conf = charData[current].config;

            const ex = Math.max(-conf.eyeRangeX, Math.min(conf.eyeRangeX, dx * 0.02));
            const ey = Math.max(-conf.eyeRangeY, Math.min(conf.eyeRangeY, dy * 0.02));
            eyeL.style.transform = `translate(${ex}px, ${ey}px)`;
            eyeR.style.transform = `translate(${ex}px, ${ey}px)`;

            face.style.transform = `translate(${dx * conf.speed}px, ${dy * conf.speed}px) rotate(${dx * conf.rotate}deg)`;
            body.style.transform = `translate(${dx * (conf.speed * 0.5)}px, ${dy * (conf.speed * 0.5)}px)`;

            requestAnimationFrame(loop);
        }

        window.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
        window.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            mouseX = touch.clientX; mouseY = touch.clientY;
        }, { passive: true });

        changeChar('cat');
        loop();
    </script>
</body>

</html>